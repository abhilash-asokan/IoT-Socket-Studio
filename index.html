<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Socket Studio</title>
    <link rel="icon" type="image/x-icon" href="static/favicon.ico">
    <link rel="stylesheet" href="static/style.css">

    <!-- SEO: Meta Description & Keywords -->
    <meta name="description"
        content="IoT Socket Studio is a mock WebSocket telemetry server and viewer. Generate and stream realistic IoT readings (temperature, humidity, etc.) for rapid prototyping and testing.">
    <meta name="keywords" content="websocket, mock server, iot, telemetry, simulator, testing, realtime, ws, wss">
    <meta name="robots" content="index,follow">

    <!-- Open Graph / Facebook -->
    <meta property="og:title" content="IoT Socket Studio – Mock WebSocket Telemetry Server">
    <meta property="og:description"
        content="Public WebSocket endpoint for streaming mock IoT telemetry. Connect from browser, CLI, or Node.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="IoT Socket Studio – Mock WebSocket Telemetry Server">
    <meta name="twitter:description"
        content="Public WebSocket endpoint for streaming mock IoT telemetry. Connect from browser, CLI, or Node.">

    <!-- Canonical -->
    <link rel="canonical" href="/">

    <!-- Accessibility helper for hidden headings -->
    <style>
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }
    </style>

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "IoT Socket Studio",
      "applicationCategory": "DeveloperApplication",
      "description": "Mock WebSocket telemetry server and viewer for IoT testing.",
      "operatingSystem": "Any",
      "url": "/"
    }
    </script>
</head>

<body>
    <h1 class="visually-hidden">IoT Socket Studio – Mock WebSocket Telemetry Server</h1>
    <div class="toolbar">
        <button id="connectBtn" class="btn primary">Connect</button>
        <button id="disconnectBtn" class="btn danger" disabled>Disconnect</button>
        <button id="clearBtn" class="btn">Clear</button>
        <label class="toggle"><input type="checkbox" id="autoscroll" checked> Auto‑scroll</label>
        <label class="toggle"><input type="checkbox" id="wrap"> Wrap</label>
        <label class="toggle">Interval (ms): <input type="number" id="intervalInput" value="5000" min="200" step="100"
                style="width: 80px;" /></label>
        <button id="applyIntervalBtn" class="btn primary">Apply</button>
        <div class="spacer"></div>
        <div class="status" id="status">Disconnected</div>
    </div>

    <div class="workspace">
        <div class="editor" id="editor"></div>
        <aside class="panel">
            <h3>Last Message</h3>
            <div id="lastJson" class="json muted">(none)</div>
            <h3>Send (optional)</h3>
            <div class="row"><label>Message</label><textarea id="outgoing" placeholder='{"ping": true}'
                    rows="13"></textarea>
            </div>
            <div class="row">
                <label></label>
                <div class="actions">
                    <button id="sendBtn" class="btn success">Send</button>
                    <button id="mockBtn" class="btn warn">Generate Telemetry</button>
                </div>
            </div>
            <div class="footer" id="footer">
                <p><strong>How to connect to IoT Socket Studio:</strong></p>
                <p>You can connect using any WebSocket client or directly from your frontend app.</p>
                <p><strong>Base URL:</strong></p>
                <code id="ws-url"></code>
                <p><strong>Example (JavaScript):</strong></p>
                <code id="ws-example"></code>
                <p>Parameters:</p>
                <ul>
                    <li><code>assetId</code> – The unique ID of the asset (e.g., <em>02i9K000005B4tcQAC</em>).</li>
                    <li><code>keys</code> – Comma‑separated telemetry names (e.g., <em>temperature,humidity</em>).</li>
                    <li><code>interval</code> (optional) – Frequency in milliseconds to receive updates.</li>
                </ul>
            </div>
        </aside>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const editorEl = document.getElementById('editor');
        const lastJsonEl = document.getElementById('lastJson');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const clearBtn = document.getElementById('clearBtn');
        const autoscroll = document.getElementById('autoscroll');
        const wrap = document.getElementById('wrap');
        const outgoing = document.getElementById('outgoing');
        const sendBtn = document.getElementById('sendBtn');
        const mockBtn = document.getElementById('mockBtn');
        const intervalInput = document.getElementById('intervalInput');
        const applyIntervalBtn = document.getElementById('applyIntervalBtn');

        let ws = null;

        function setStatus(s, color) { statusEl.textContent = s; if (color) statusEl.style.color = color; }

        function syntaxHighlight(json) {
            if (typeof json !== 'string') json = JSON.stringify(json, null, 2);
            // Escape HTML first
            let s = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // 1) Highlight strings first
            s = s.replace(/"(\\u[a-fA-F0-9]{4}|\\[^u]|[^\\"])*"/g, '<span class="str">$&</span>');

            // 2) Numbers
            s = s.replace(/(^|[^\w])(-?\d+(?:\.\d+)?(?:[eE][+\-]?\d+)?)/g, '$1<span class="num">$2</span>');

            // 3) Booleans and null
            s = s.replace(/\b(true|false)\b/g, '<span class="bool">$1</span>');
            s = s.replace(/\bnull\b/g, '<span class="null">null</span>');

            // 4) Keys: wrap string tokens that are immediately followed by a colon
            s = s.replace(/<span class=\"str\">(\"(?:\\u[a-fA-F0-9]{4}|\\[^u]|[^\\\"])*\")<\/span>(\s*:)/g, '<span class="key">$1</span>$2');

            return s;
        }

        function logLine(prefix, data) {
            const line = document.createElement('div');
            line.className = 'line';
            const time = new Date().toLocaleTimeString();
            const badge = `<span class="badge">${time} ${prefix}</span>`;

            let payloadHTML = '';
            try {
                const obj = typeof data === 'string' ? JSON.parse(data) : data;
                payloadHTML = `<div class="payload json">${syntaxHighlight(JSON.stringify(obj, null, 2))}</div>`;
            } catch (_) {
                const safe = String(data)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                payloadHTML = `<div class="payload">${safe}</div>`;
            }

            line.innerHTML = badge + payloadHTML;
            editorEl.appendChild(line);
            if (autoscroll.checked) editorEl.scrollTop = editorEl.scrollHeight;
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            const interval = Math.max(200, Number(intervalInput.value || 5000));
            ws = new WebSocket(`ws://localhost:8080/ws?assetId=demo&interval=${interval}&keys=temperature,humidity&count=1`);
            setStatus('connecting…', '#fbbf24');
            ws.onopen = () => {
                setStatus('Connected', '#22c55e');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                logLine('[open]', '');
            };
            ws.onmessage = (e) => {
                logLine('[msg]', e.data);
                try {
                    const obj = JSON.parse(e.data);
                    lastJsonEl.classList.remove('muted');
                    lastJsonEl.innerHTML = syntaxHighlight(obj);
                } catch (_) {
                    lastJsonEl.classList.remove('muted');
                    lastJsonEl.textContent = e.data;
                }
            };
            ws.onerror = (e) => {
                logLine('[error]', e.message || e.type);
            };
            ws.onclose = () => {
                setStatus('Disconnected', '#94a3b8');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                logLine('[close]', '');
            };
        }

        function disconnect() { if (ws) { ws.close(); } }

        function clearEditor() { editorEl.innerHTML = ''; lastJsonEl.textContent = '(none)'; lastJsonEl.classList.add('muted'); }

        connectBtn.onclick = connect;
        disconnectBtn.onclick = disconnect;
        clearBtn.onclick = clearEditor;
        sendBtn.onclick = () => {
            const text = outgoing.value.trim();
            if (!text) return;
            try {
                const obj = JSON.parse(text);
                ws?.send(JSON.stringify(obj));
                logLine('[send]', JSON.stringify(obj));
            } catch (_) {
                ws?.send(text);
                logLine('[send]', text);
            }
        };

        applyIntervalBtn.onclick = () => {
            clearEditor();
            disconnect();
            setTimeout(connect, 100);
        };

        const UI_KEY_NAMES = ['temperature', 'humidity', 'pressure', 'vibration', 'voltage'];
        function uiUnitFor(name) {
            switch (name) {
                case 'temperature': return '°C';
                case 'humidity': return '%';
                case 'pressure': return 'hPa';
                case 'vibration': return 'mm/s';
                case 'voltage': return 'V';
                default: return '';
            }
        }
        function uiGenerateValue(name) {
            switch (name) {
                case 'temperature': return (20 + Math.random() * 10).toFixed(2);
                case 'humidity': return (40 + Math.random() * 60).toFixed(2);
                case 'pressure': return (900 + Math.random() * 200).toFixed(2);
                case 'vibration': return (0 + Math.random() * 10).toFixed(2);
                case 'voltage': return (200 + Math.random() * 50).toFixed(2);
                default: return Math.random().toFixed(2);
            }
        }
        function createMockReadingUI() {
            const key = UI_KEY_NAMES[Math.floor(Math.random() * UI_KEY_NAMES.length)];
            return {
                assetId: "02i9K000005B4tcQAC",
                telemetry: [{
                    value: Number(uiGenerateValue(key)),
                    name: key,
                    type: "number",
                    unit: uiUnitFor(key),
                    timestamp: Date.now()
                }],
                keyName: key
            };
        }

        mockBtn.onclick = () => {
            outgoing.value = JSON.stringify(createMockReadingUI(), null, 2);
        };

        document.getElementById('ws-url').textContent = `ws://${location.host}/ws`;
        document.getElementById('ws-example').textContent = `const ws = new WebSocket("ws://${location.host}/ws?assetId=MyAsset&keys=temperature,humidity");`;

        function setWrap() {
            if (wrap.checked) {
                editorEl.classList.add('wrap');
            } else {
                editorEl.classList.remove('wrap');
            }
        }

        setWrap();
        wrap.onchange = setWrap;

        // auto-connect on load
        connect();
    </script>
</body>

</html>